
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://jxhkpzdbfvefcapwgrwn.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4aGtwemRiZnZlZmNhcHdncnduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxMjUxNTIsImV4cCI6MjA1ODcwMTE1Mn0.OTGNN7ul4kcRCheobvNOIAz6WIAjP2ZsGNp5MtVGsbo";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: localStorage
  }
});

// Function to save posts to localStorage as a fallback
export const savePostsToLocalStorage = (posts, clientId) => {
  try {
    // Get existing posts from localStorage
    const existingPostsJSON = localStorage.getItem('calendarPosts');
    let existingPosts = [];
    
    if (existingPostsJSON) {
      existingPosts = JSON.parse(existingPostsJSON);
      
      // Remove any posts for this client (to update them)
      existingPosts = existingPosts.filter(post => post.clientId !== clientId);
    }
    
    // Add the new/updated posts for this client
    const updatedPosts = [...existingPosts, ...posts];
    
    // Save back to localStorage
    localStorage.setItem('calendarPosts', JSON.stringify(updatedPosts));
    
    return true;
  } catch (error) {
    console.error('Error saving posts to localStorage:', error);
    return false;
  }
};

// Function to get posts from localStorage by clientId
export const getPostsFromLocalStorage = (clientId) => {
  try {
    const postsJSON = localStorage.getItem('calendarPosts');
    if (!postsJSON) return [];
    
    const allPosts = JSON.parse(postsJSON);
    return allPosts.filter(post => post.clientId === clientId);
  } catch (error) {
    console.error('Error getting posts from localStorage:', error);
    return [];
  }
};

// Function to get all posts from localStorage
export const getAllPostsFromLocalStorage = () => {
  try {
    const postsJSON = localStorage.getItem('calendarPosts');
    if (!postsJSON) return [];
    
    return JSON.parse(postsJSON);
  } catch (error) {
    console.error('Error getting all posts from localStorage:', error);
    return [];
  }
};

// Function to save a single post to localStorage
export const savePostToLocalStorage = (post) => {
  try {
    const allPosts = getAllPostsFromLocalStorage();
    
    // Check if post already exists (by id)
    const existingPostIndex = allPosts.findIndex(p => p.id === post.id);
    
    if (existingPostIndex >= 0) {
      // Update existing post
      allPosts[existingPostIndex] = post;
    } else {
      // Add new post
      allPosts.push(post);
    }
    
    localStorage.setItem('calendarPosts', JSON.stringify(allPosts));
    return true;
  } catch (error) {
    console.error('Error saving post to localStorage:', error);
    return false;
  }
};

// Function to delete a post from localStorage
export const deletePostFromLocalStorage = (postId) => {
  try {
    const allPosts = getAllPostsFromLocalStorage();
    const filteredPosts = allPosts.filter(post => post.id !== postId);
    localStorage.setItem('calendarPosts', JSON.stringify(filteredPosts));
    return true;
  } catch (error) {
    console.error('Error deleting post from localStorage:', error);
    return false;
  }
};

// Helper function to check if Supabase tables exist - replaced with simple error check
export const checkSupabaseTables = async () => {
  try {
    // Try a simple query to see if Supabase is accessible
    const { data, error } = await supabase.from('calendar_posts').select('count');
    
    // If there's an error, Supabase is likely not set up correctly
    if (error) {
      console.warn('Supabase not properly configured, falling back to localStorage');
      return false;
    }
    
    return true;
  } catch (error) {
    console.warn('Failed to check Supabase configuration:', error);
    return false;
  }
};

// Helper to create a storage bucket if it doesn't exist - replaced with simple availability check
export const ensureStorageBucketExists = async () => {
  try {
    // Simple check if storage is accessible
    const { data, error } = await supabase.storage.getBucket('post_images');
    
    if (error) {
      console.warn('Supabase storage not properly configured');
      return false;
    }
    
    return true;
  } catch (error) {
    console.warn('Supabase storage not accessible:', error);
    return false;
  }
};
